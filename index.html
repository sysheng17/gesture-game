<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>手指速算挑戰 - 順暢優化版</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    
    <style>
        :root { --primary: #00d2ff; --success: #00ff88; --danger: #ff4e50; }
        body { 
            margin: 0; background: #0f0f0f; color: white; 
            font-family: 'PingFang TC', sans-serif;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        #video-wrap { width: 100%; height: 35vh; background: #000; position: relative; }
        #input_video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #guide-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }

        #game-ui { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #target-number { font-size: 140px; font-weight: 900; color: var(--primary); margin: 0; transition: all 0.2s; }
        #timer-bg { width: 80%; height: 12px; background: #333; border-radius: 6px; margin: 25px 0; overflow: hidden; }
        #timer-bar { width: 100%; height: 100%; background: var(--danger); }
        
        #stats { font-size: 20px; letter-spacing: 2px; }
        #detected-hint { margin-top: 10px; color: var(--success); font-weight: bold; }

        /* 開始與結束蓋板 */
        #overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; text-align: center;
        }
        .btn {
            padding: 18px 45px; font-size: 22px; background: var(--primary); color: #000;
            border: none; border-radius: 50px; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.4);
        }
        .btn:disabled { background: #555; color: #888; box-shadow: none; }
        #msg { margin-bottom: 20px; padding: 0 20px; }
    </style>
</head>
<body>

    <div id="overlay">
        <div id="msg">
            <h1 id="title">手指速算挑戰</h1>
            <p id="desc">正在準備 AI 引擎...</p>
        </div>
        <button id="startBtn" class="btn" disabled>載入中...</button>
    </div>

    <div id="video-wrap">
        <video id="input_video" playsinline></video>
        <canvas id="guide-canvas"></canvas>
    </div>

    <div id="game-ui">
        <div id="target-number">?</div>
        <div id="timer-bg"><div id="timer-bar"></div></div>
        <div id="stats">得分: <span id="score">0</span> | 生命: <span id="hp">3</span></div>
        <div id="detected-hint">偵測到：<span id="detected-count">0</span></div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('guide-canvas');
        const ctx = canvasElement.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const overlay = document.getElementById('overlay');
        const titleEl = document.getElementById('title');
        const descEl = document.getElementById('desc');
        
        let game = { active: false, score: 0, hp: 3, target: 0, timeLeft: 5, detected: 0, lastTarget: 0 };
        let modelLoaded = false;
        let cameraStarted = false;

        // --- MediaPipe 初始化 ---
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });

        hands.onResults((results) => {
            drawSkeleton(results);
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                let count = 0;
                if (lm[8].y < lm[6].y) count++;
                if (lm[12].y < lm[10].y) count++;
                if (lm[16].y < lm[14].y) count++;
                if (lm[20].y < lm[18].y) count++;
                if (Math.abs(lm[4].x - lm[5].x) > 0.08) count++;
                
                game.detected = count;
                document.getElementById('detected-count').innerText = count;
                if (game.active && count === game.target) handleCorrect();
            }
        });

        function drawSkeleton(results) {
            ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    ctx.fillStyle = "#00d2ff";
                    for (const point of landmarks) {
                        ctx.beginPath();
                        ctx.arc(point.x * canvasElement.width, point.y * canvasElement.height, 2, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                }
            }
        }

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });

        // 首次模擬加載（僅執行一次）
        setTimeout(() => {
            modelLoaded = true;
            startBtn.disabled = false;
            startBtn.innerText = "開始挑戰";
            descEl.innerText = "AI 準備就緒，隨時可以開始！";
        }, 4000);

        function startGame() {
            overlay.style.display = 'none';
            // 重置遊戲數據
            game.score = 0;
            game.hp = 3;
            game.active = true;
            document.getElementById('score').innerText = "0";
            document.getElementById('hp').innerText = "3";
            
            // 只有第一次需要啟動相機硬體
            if (!cameraStarted) {
                camera.start();
                cameraStarted = true;
            }
            
            nextRound();
            requestAnimationFrame(tick);
        }

        function nextRound() {
            // 1. 防止連續出現同樣數字
            let newTarget;
            do {
                newTarget = Math.floor(Math.random() * 5) + 1;
            } while (newTarget === game.lastTarget);
            
            game.target = newTarget;
            game.lastTarget = newTarget;
            
            game.timeLeft = 5;
            const el = document.getElementById('target-number');
            el.innerText = game.target;
            el.style.color = "var(--primary)";
            el.style.transform = "scale(1)";
        }

        function handleCorrect() {
            game.active = false;
            game.score += 10;
            document.getElementById('score').innerText = game.score;
            const el = document.getElementById('target-number');
            el.style.color = "var(--success)";
            el.style.transform = "scale(1.2)";
            // 答對後短暫停頓進入下一題
            setTimeout(() => { 
                if (game.hp > 0) {
                    game.active = true; 
                    nextRound(); 
                }
            }, 600);
        }

        function tick() {
            if (!game.active || game.hp <= 0) return;

            game.timeLeft -= 0.03; // 控制倒數速度
            document.getElementById('timer-bar').style.width = (game.timeLeft / 5) * 100 + "%";
            
            if (game.timeLeft <= 0) {
                game.hp--;
                document.getElementById('hp').innerText = game.hp;
                if (game.hp <= 0) {
                    gameOver();
                } else {
                    nextRound();
                }
            }
            if (game.hp > 0) requestAnimationFrame(tick);
        }

        function gameOver() {
            game.active = false;
            overlay.style.display = 'flex';
            titleEl.innerText = "遊戲結束";
            descEl.innerHTML = `最終得分：<span style="font-size:32px; color:var(--success)">${game.score}</span><br>模型已在後台載入，可立即重新開始。`;
            startBtn.innerText = "再玩一次";
        }

        startBtn.onclick = startGame;
    </script>
</body>
</html>
