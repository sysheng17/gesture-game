<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>手指速算挑戰 - 邏輯修正版</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    
    <style>
        :root { --primary: #00d2ff; --success: #00ff88; --danger: #ff4e50; }
        body { margin: 0; background: #0f0f0f; color: white; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #video-wrap { width: 100%; height: 35vh; background: #000; position: relative; }
        #input_video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #guide-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }
        #game-ui { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #target-number { font-size: 140px; font-weight: 900; color: var(--primary); margin: 0; transition: transform 0.2s; }
        #timer-bg { width: 80%; height: 12px; background: #333; border-radius: 6px; margin: 25px 0; overflow: hidden; }
        #timer-bar { width: 100%; height: 100%; background: var(--danger); }
        #stats { font-size: 20px; }
        #detected-hint { margin-top: 10px; color: var(--success); font-weight: bold; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; }
        .btn { padding: 18px 45px; font-size: 22px; background: var(--primary); color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }
        .btn:disabled { background: #555; color: #888; }
    </style>
</head>
<body>

    <div id="overlay">
        <div id="msg">
            <h1 id="title">手指速算挑戰</h1>
            <p id="desc">正在準備 AI 引擎...</p>
        </div>
        <button id="startBtn" class="btn" disabled>載入中...</button>
    </div>

    <div id="video-wrap">
        <video id="input_video" playsinline></video>
        <canvas id="guide-canvas"></canvas>
    </div>

    <div id="game-ui">
        <div id="target-number">?</div>
        <div id="timer-bg"><div id="timer-bar"></div></div>
        <div id="stats">得分: <span id="score">0</span> | 生命: <span id="hp">3</span></div>
        <div id="detected-hint">偵測到：<span id="detected-count">0</span></div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('guide-canvas');
        const ctx = canvasElement.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const overlay = document.getElementById('overlay');
        const titleEl = document.getElementById('title');
        const descEl = document.getElementById('desc');
        const timerBar = document.getElementById('timer-bar');
        
        // 核心遊戲狀態
        let game = {
            active: false,
            score: 0,
            hp: 3,
            target: 0,
            lastTarget: 0,
            timeLeft: 5,
            detected: 0
        };

        let cameraStarted = false;
        let animationFrameId = null;

        // --- MediaPipe 初始化 ---
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });

        hands.onResults((results) => {
            drawSkeleton(results);
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                let count = 0;
                // 判斷手指開闔 (Landmarks 8, 12, 16, 20 vs 6, 10, 14, 18)
                [8, 12, 16, 20].forEach((tip, idx) => {
                    const pip = [6, 10, 14, 18][idx];
                    if (lm[tip].y < lm[pip].y) count++;
                });
                // 拇指獨立判斷
                if (Math.abs(lm[4].x - lm[5].x) > 0.08) count++;
                
                game.detected = count;
                document.getElementById('detected-count').innerText = count;
                
                // 檢查答案：必須是遊戲中且數字相符
                if (game.active && count === game.target) {
                    handleCorrect();
                }
            }
        });

        function drawSkeleton(results) {
            ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    ctx.fillStyle = "#00d2ff";
                    for (const point of landmarks) {
                        ctx.beginPath();
                        ctx.arc(point.x * canvasElement.width, point.y * canvasElement.height, 2, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                }
            }
        }

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });

        // 初始化下載模型
        setTimeout(() => {
            startBtn.disabled = false;
            startBtn.innerText = "開始挑戰";
            descEl.innerText = "模型載入完成！";
        }, 4000);

        function startGame() {
            // 1. 清理舊的動畫循環（防止第二次遊玩加速或停住）
            if (animationFrameId) cancelAnimationFrame(animationFrameId);

            overlay.style.display = 'none';
            
            // 2. 初始化所有狀態
            game.score = 0;
            game.hp = 3;
            game.lastTarget = 0; // 重置上一次數字
            game.active = true;
            
            document.getElementById('score').innerText = "0";
            document.getElementById('hp').innerText = "3";
            
            if (!cameraStarted) {
                camera.start();
                cameraStarted = true;
            }
            
            nextRound();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function nextRound() {
            let nextNum;
            // 確保新數字不重複
            do {
                nextNum = Math.floor(Math.random() * 5) + 1;
            } while (nextNum === game.lastTarget);
            
            game.target = nextNum;
            game.lastTarget = nextNum;
            game.timeLeft = 5; // 重置倒數時間
            
            const el = document.getElementById('target-number');
            el.innerText = game.target;
            el.style.color = "var(--primary)";
            el.style.transform = "scale(1)";
        }

        function handleCorrect() {
            game.active = false; // 暫停計時與判斷
            game.score += 10;
            document.getElementById('score').innerText = game.score;
            
            const el = document.getElementById('target-number');
            el.style.color = "var(--success)";
            el.style.transform = "scale(1.2)";
            
            // 延遲進入下一題，提供視覺回饋
            setTimeout(() => {
                if (game.hp > 0) {
                    game.active = true;
                    nextRound();
                }
            }, 600);
        }

        function gameLoop() {
            if (!game.active) {
                // 如果是暫停狀態(答對瞬間)，動畫繼續跑但時間不動
                animationFrameId = requestAnimationFrame(gameLoop);
                return;
            }

            game.timeLeft -= 0.025; // 每一影格減少固定時間
            const percentage = (game.timeLeft / 5) * 100;
            timerBar.style.width = percentage + "%";
            
            if (game.timeLeft <= 0) {
                game.hp--;
                document.getElementById('hp').innerText = game.hp;
                
                if (game.hp <= 0) {
                    endGame();
                    return;
                } else {
                    nextRound();
                }
            }
            
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function endGame() {
            game.active = false;
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            
            overlay.style.display = 'flex';
            titleEl.innerText = "挑戰結束";
            descEl.innerHTML = `最終得分：<span style="font-size:32px; color:var(--success)">${game.score}</span><br>模型已就緒，可立即再挑戰。`;
            startBtn.innerText = "再次挑戰";
        }

        startBtn.onclick = startGame;
    </script>
</body>
</html>
